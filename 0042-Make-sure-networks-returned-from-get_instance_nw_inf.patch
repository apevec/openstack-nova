From 100d683b18601fcfd426d4990d68becce260307a Mon Sep 17 00:00:00 2001
From: Brad Hall <brad@nicira.com>
Date: Mon, 3 Oct 2011 12:07:50 -0700
Subject: [PATCH] Make sure networks returned from get_instance_nw_info have a
 label

(cherry picked from commit 606827f92e74d8ff5ae13e3210abedd511fd4518)

Change-Id: I3f1fd91cb05150bcbd5b32db1e8345b66d7fa348
---
 nova/network/quantum/manager.py            |    2 ++
 nova/network/quantum/quantum_connection.py |    4 ++++
 nova/tests/test_quantum.py                 |    3 +++
 3 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/nova/network/quantum/manager.py b/nova/network/quantum/manager.py
index 23a9aba..4045784 100644
--- a/nova/network/quantum/manager.py
+++ b/nova/network/quantum/manager.py
@@ -241,7 +241,9 @@ class QuantumManager(manager.FlatManager):
                 'injected': True,
                 'multi_host': False}
 
+            q_tenant_id = project_id or FLAGS.quantum_default_tenant_id
             info = {
+                'label': self.q_conn.get_network_name(q_tenant_id, net_id),
                 'gateway': v4_subnet['gateway'],
                 'dhcp_server': v4_subnet['gateway'],
                 'broadcast': v4_subnet['broadcast'],
diff --git a/nova/network/quantum/quantum_connection.py b/nova/network/quantum/quantum_connection.py
index 2191765..ce07bc1 100644
--- a/nova/network/quantum/quantum_connection.py
+++ b/nova/network/quantum/quantum_connection.py
@@ -60,6 +60,10 @@ class QuantumClientConnection(object):
         resdict = self.client.create_network(data, tenant=tenant_id)
         return resdict["network"]["id"]
 
+    def get_network_name(self, tenant_id, network_id):
+        net = self.client.show_network_details(network_id, tenant=tenant_id)
+        return net["network"]["name"]
+
     def delete_network(self, tenant_id, net_id):
         """Deletes Quantum network with specified UUID."""
         self.client.delete_network(net_id, tenant=tenant_id)
diff --git a/nova/tests/test_quantum.py b/nova/tests/test_quantum.py
index 0feec9b..e8f09f9 100644
--- a/nova/tests/test_quantum.py
+++ b/nova/tests/test_quantum.py
@@ -61,6 +61,9 @@ class FakeQuantumClientConnection(object):
         except KeyError:
             return False
 
+    def get_network_name(self, tenant_id, net_id):
+        return self.nets[net_id]['net-name']
+
     def _confirm_not_attached(self, interface_id):
         for n in self.nets.values():
             for p in n['ports'].values():
-- 
1.7.6.5

