From 7bd0b6b004e686fa97ebc0a2e5e9bb75d95aaeea Mon Sep 17 00:00:00 2001
From: Chuck Short <chuck.short@canonical.com>
Date: Tue, 13 Dec 2011 13:45:43 -0500
Subject: [PATCH] Fix tgtadm off by one error. Fixes bug #871278

(cherry picked from commit 15cc877cc2af71135b896974f17cb4a63291a08c)

Change-Id: Ia359045465ada9753b86d1a08cc947966b3ac899
Signed-off-by: Chuck Short <chuck.short@canonical.com>
---
 nova/volume/driver.py |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/nova/volume/driver.py b/nova/volume/driver.py
index 82f0106..7069626 100644
--- a/nova/volume/driver.py
+++ b/nova/volume/driver.py
@@ -533,9 +533,14 @@ class ISCSIDriver(VolumeDriver):
 
         self._iscsiadm_update(iscsi_properties, "node.startup", "automatic")
 
-        mount_device = ("/dev/disk/by-path/ip-%s-iscsi-%s-lun-0" %
-                        (iscsi_properties['target_portal'],
-                         iscsi_properties['target_iqn']))
+        if FLAGS.iscsi_helper == 'tgtadm':
+            mount_device = ("/dev/disk/by-path/ip-%s-iscsi-%s-lun-1" %
+                            (iscsi_properties['target_portal'],
+                             iscsi_properties['target_iqn']))
+        else:
+            mount_device = ("/dev/disk/by-path/ip-%s-iscsi-%s-lun-0" %
+                            (iscsi_properties['target_portal'],
+                             iscsi_properties['target_iqn']))
 
         # The /dev/disk/by-path/... node is not always present immediately
         # TODO(justinsb): This retry-with-delay is a pattern, move to utils?
-- 
1.7.6.5

